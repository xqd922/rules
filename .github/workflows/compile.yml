name: Compile Rules

on:
  push:
    paths:
      - '**/src/mihomo/*.yaml'
      - '**/src/singbox/*.json'
  workflow_dispatch:

permissions:
  contents: write

env:
  MIHOMO_VERSION: "1.18.10"
  SINGBOX_VERSION: "1.10.7"

jobs:
  compile:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ========== 下载工具 ==========
      - name: Download mihomo
        run: |
          wget -q "https://github.com/MetaCubeX/mihomo/releases/download/v${MIHOMO_VERSION}/mihomo-linux-amd64-v${MIHOMO_VERSION}.gz"
          gzip -d "mihomo-linux-amd64-v${MIHOMO_VERSION}.gz"
          chmod +x "mihomo-linux-amd64-v${MIHOMO_VERSION}"
          mv "mihomo-linux-amd64-v${MIHOMO_VERSION}" mihomo

      - name: Download sing-box
        run: |
          wget -q "https://github.com/SagerNet/sing-box/releases/download/v${SINGBOX_VERSION}/sing-box-${SINGBOX_VERSION}-linux-amd64.tar.gz"
          tar -xzf "sing-box-${SINGBOX_VERSION}-linux-amd64.tar.gz"
          mv "sing-box-${SINGBOX_VERSION}-linux-amd64/sing-box" sing-box
          chmod +x sing-box

      # ========== 编译 Mihomo ==========
      # 源文件: */src/mihomo/*.yaml
      # 输出:   */*.mrs
      # 类型:   默认 domain, 文件名含 -ip 则为 ipcidr
      - name: Compile Mihomo MRS
        run: |
          for file in $(find . -path '*/src/mihomo/*.yaml'); do
            name=$(basename "$file" .yaml)
            outdir=$(dirname "$(dirname "$(dirname "$file")")")

            # 判断类型
            if [[ "$name" == *"-ip"* ]]; then
              type="ipcidr"
            else
              type="domain"
            fi

            echo "[$name] $file -> $outdir/$name.mrs ($type)"
            ./mihomo convert-ruleset "$type" yaml "$file" "$outdir/$name.mrs"
          done

      # ========== 编译 sing-box ==========
      # 源文件: */src/singbox/*.json
      # 输出:   */*.srs
      - name: Compile sing-box SRS
        run: |
          for file in $(find . -path '*/src/singbox/*.json'); do
            name=$(basename "$file" .json)
            outdir=$(dirname "$(dirname "$(dirname "$file")")")

            echo "[$name] $file -> $outdir/$name.srs"
            ./sing-box rule-set compile "$file" -o "$outdir/$name.srs"
          done

      # ========== 提交 ==========
      - name: Commit changes
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add -A

          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "chore: 自动编译规则文件"
            git push
          fi
